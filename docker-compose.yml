# Docker Compose file for local development
version: '3.8'

services:
  # ==============================================
  # PostgreSQL Database Service
  # ==============================================
  biddingservice:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "5435:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bidding-network

  # ==============================================
  # NestJS Application Service
  # ==============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: biddingservice-app
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - TREBLLE_SDK_TOKEN=${TREBLLE_SDK_TOKEN}
      - TREBLLE_API_KEY=${TREBLLE_API_KEY}
      - KINDE_JWKS_URI=${KINDE_JWKS_URI}
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - ENDPOINT_SECRET=${ENDPOINT_SECRET}
      - NODE_ENV=production
      - REDIS_HOST=redis-service  # Use service name, not localhost
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis-service:6379  
    env_file:
      - .env
    depends_on:
      biddingservice:
        condition: service_healthy
      redis-service:
        condition: service_healthy
    networks:
      - bidding-network
    # Remove or comment out this volume for production mode:
    # volumes:
    #   - ./src:/usr/src/app/src  # Use this for development mode only

  # ==============================================
  # Redis Service
  # ==============================================
  redis-service:
    image: redis:7-alpine
    container_name: bidding-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server 
      --appendonly yes 
      --requirepass ${REDIS_PASSWORD} 
      --bind 0.0.0.0
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bidding-network

networks:
  bidding-network:
    driver: bridge

volumes:
  postgres_data:
  redis-data: