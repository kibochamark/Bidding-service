# Docker Compose file for local development
# Runs PostgreSQL + NestJS app together
# Command: docker-compose up -d

services:
  # ==============================================
  # PostgreSQL Database Service
  # ==============================================
  biddingservice:
    # Use official PostgreSQL 16 image
    image: postgres:16-alpine

    # Restart policy: always restart if it crashes
    restart: unless-stopped

    # Environment variables for PostgreSQL
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: kibo_password
      POSTGRES_DB: bidding_db

    # Port mapping: host:container
    # Access from host machine: localhost:5435
    ports:
      - "5435:5432"

    # Volume for data persistence
    # Database data survives container restarts!
    volumes:
      - postgres_data:/var/lib/postgresql/data

    # Health check: ensure database is ready before app starts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    # Connect to custom network
    networks:
      - bidding-network

  # ==============================================
  # NestJS Application Service
  # ==============================================
  app:
    # Build from local Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      target: production  # Use production stage

    # Container name (easier to reference)
    container_name: biddingservice-app

    # Restart policy
    restart: unless-stopped

    # Port mapping: host:container
    # Access app at: http://localhost:3000
    ports:
      - "3000:4000"

    # Environment variables for the app
    environment:
      # Database connection (using service name 'postgres')
      DATABASE_URL: "postgresql://postgres:kibo_password@postgres:5432/bidding_db?schema=public"

      # Kinde Auth configuration (from your .env)
      KINDE_CLIENT_ID: "da1058d120914598aaae2d460c519278"
      KINDE_CLIENT_SECRET: "cx5dq6QTl5qcGqfDHA45IgmkTpm0AYkwzCFyGJVyUnQYdyiFXnC"
      KINDE_ISSUER_URL: "https://kolakodhek.kinde.com"
      KINDE_SITE_URL: "http://localhost:3000"
      KINDE_POST_LOGOUT_REDIRECT_URL: "http://localhost:3000"
      KINDE_POST_LOGIN_REDIRECT_URL: "http://localhost:3000"
      KINDE_WELL_KNOWN_URL: "https://kolakodhek.kinde.com/.well-known/jwks.json"

      # Node environment
      NODE_ENV: "production"

    # Wait for postgres to be healthy before starting
    depends_on:
      biddingservice:
        condition: service_healthy

    # Connect to custom network
    networks:
      - bidding-network

    # Optional: Mount source code for development (hot reload)
    # Uncomment these lines for development mode:
    volumes:
      - ./src:/usr/src/app/src

# ==============================================
# Networks
# ==============================================
networks:
  bidding-network:
    # Custom bridge network
    # Allows services to communicate using service names
    driver: bridge

# ==============================================
# Volumes
# ==============================================
volumes:
  postgres_data:
    # Named volume for PostgreSQL data
    # Data persists even when containers are removed!
